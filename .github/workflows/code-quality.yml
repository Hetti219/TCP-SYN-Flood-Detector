name: Code Quality

on:
  pull_request:
    branches: [ '**' ]
    paths:
      - '**.c'
      - '**.h'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  code-style:
    name: Code Style Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for common issues
        run: |
          echo "Checking for common code issues..."

          # Check for TODO/FIXME comments
          echo "## Checking for TODO/FIXME comments"
          if grep -rn "TODO\|FIXME" src/ include/ tests/ 2>/dev/null; then
            echo "⚠️  Found TODO/FIXME comments - consider creating issues for these"
          else
            echo "✓ No TODO/FIXME comments found"
          fi

          # Check for debug prints that shouldn't be committed
          echo ""
          echo "## Checking for debug statements"
          if grep -rn "printf.*DEBUG\|fprintf.*DEBUG" src/ 2>/dev/null; then
            echo "❌ Found debug printf statements - please use logger instead"
            exit 1
          else
            echo "✓ No debug printf statements found"
          fi

          # Check for hardcoded paths
          echo ""
          echo "## Checking for hardcoded paths"
          if grep -rn "/tmp/test\|/home/" src/ include/ 2>/dev/null | grep -v "test_"; then
            echo "⚠️  Found potential hardcoded paths"
          else
            echo "✓ No suspicious hardcoded paths found"
          fi

          # Check for proper error handling
          echo ""
          echo "## Checking for unchecked return values"
          if grep -rn "malloc\|calloc\|realloc" src/ | grep -v "if.*==.*NULL\|assert"; then
            echo "⚠️  Found potential unchecked memory allocations"
          else
            echo "✓ Memory allocations appear to be checked"
          fi

      - name: Check file permissions
        run: |
          echo "Checking file permissions..."

          # Check for executable source files (shouldn't be executable)
          if find src/ include/ -type f \( -name "*.c" -o -name "*.h" \) -executable 2>/dev/null | grep .; then
            echo "❌ Source files should not be executable"
            exit 1
          else
            echo "✓ Source file permissions correct"
          fi

      - name: Check for trailing whitespace
        run: |
          echo "Checking for trailing whitespace..."

          # Find files with trailing whitespace
          files_with_trailing=$(find src/ include/ tests/ -type f \( -name "*.c" -o -name "*.h" \) -exec grep -l " $" {} \; 2>/dev/null)

          if [ -n "$files_with_trailing" ]; then
            echo "⚠️  Files with trailing whitespace:"
            echo "$files_with_trailing"
            echo ""
            echo "Consider running: sed -i 's/[[:space:]]*$//' <file>"
          else
            echo "✓ No trailing whitespace found"
          fi

      - name: Check for tabs vs spaces consistency
        run: |
          echo "Checking indentation consistency..."

          # This project uses tabs for indentation
          files_with_spaces=$(find src/ include/ -type f \( -name "*.c" -o -name "*.h" \) -exec grep -l "^    " {} \; 2>/dev/null)

          if [ -n "$files_with_spaces" ]; then
            echo "⚠️  Files using spaces instead of tabs for indentation:"
            echo "$files_with_spaces"
            echo ""
            echo "This project uses tabs for indentation. Please adjust your editor settings."
          else
            echo "✓ Indentation is consistent"
          fi

  complexity-check:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install lizard
        run: pip install lizard

      - name: Run complexity analysis
        run: |
          echo "Analyzing code complexity..."

          lizard src/ -l c -w -C 15 -L 100 -a 5 > complexity-report.txt || true

          if [ -s complexity-report.txt ]; then
            echo "## Code Complexity Report" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat complexity-report.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY

            # Check for functions that exceed thresholds
            if grep -q "!!!" complexity-report.txt; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ **Some functions exceed complexity thresholds**" >> $GITHUB_STEP_SUMMARY
              echo "Consider refactoring functions marked with !!!" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload complexity report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: complexity-report
          path: complexity-report.txt
          retention-days: 30

  security-patterns:
    name: Security Pattern Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for insecure patterns
        run: |
          echo "Checking for insecure coding patterns..."

          errors=0

          # Check for unsafe string functions
          echo "## Checking for unsafe string functions"
          if grep -rn "strcpy\|strcat\|sprintf\|gets" src/ include/; then
            echo "❌ Found unsafe string functions - use strncpy, strncat, snprintf instead"
            errors=$((errors + 1))
          else
            echo "✓ No unsafe string functions found"
          fi

          # Check for potential command injection
          echo ""
          echo "## Checking for potential command injection"
          if grep -rn "system\|popen\|exec" src/ include/ | grep -v "test_\|comment"; then
            echo "⚠️  Found system/exec calls - ensure proper input sanitization"
          else
            echo "✓ No obvious command injection risks"
          fi

          # Check for hardcoded credentials
          echo ""
          echo "## Checking for hardcoded secrets"
          if grep -rEin "password.*=.*['\"]|api[_-]?key.*=.*['\"]|secret.*=.*['\"]" src/ include/; then
            echo "❌ Found potential hardcoded credentials"
            errors=$((errors + 1))
          else
            echo "✓ No hardcoded credentials found"
          fi

          # Check for SQL injection (unlikely but check anyway)
          echo ""
          echo "## Checking for SQL injection patterns"
          if grep -rn "SELECT.*%s\|INSERT.*%s\|UPDATE.*%s" src/; then
            echo "⚠️  Found potential SQL injection risk"
          else
            echo "✓ No SQL injection patterns found"
          fi

          if [ $errors -gt 0 ]; then
            echo ""
            echo "❌ Security check failed with $errors error(s)"
            exit 1
          fi

          echo ""
          echo "✓ All security pattern checks passed"
