name: PR Labels

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [ '**' ]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-pr:
    name: Auto-label PR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Label based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  check-pr-description:
    name: PR Description Check
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Check if PR has adequate description
            if (body.length < 50) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `ðŸ‘‹ Thank you for your contribution!

                âš ï¸ **Please add a description to your PR**

                A good PR description should include:
                - **What** changes you made
                - **Why** you made these changes
                - **How** to test the changes
                - Any **related issues** (e.g., "Fixes #123")

                This helps reviewers understand your contribution and speeds up the review process.`
              });
            }

            // Check if PR title is descriptive
            if (pr.title.length < 10) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `âš ï¸ **Please use a more descriptive PR title**

                Good examples:
                - "Add support for IPv6 addresses"
                - "Fix memory leak in tracker module"
                - "Update installation docs for Debian 12"

                Avoid titles like:
                - "Update"
                - "Fix bug"
                - "Changes"`
              });
            }

  check-tests:
    name: Verify Tests Added
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if tests were added for code changes
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Get list of changed files
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            const sourceFiles = files.filter(f =>
              f.filename.startsWith('src/') &&
              f.filename.endsWith('.c') &&
              f.status !== 'removed'
            );

            const testFiles = files.filter(f =>
              f.filename.startsWith('tests/') &&
              f.filename.endsWith('.c')
            );

            // If source code changed but no tests added/modified
            if (sourceFiles.length > 0 && testFiles.length === 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `## ðŸ§ª Test Coverage Reminder

                This PR modifies source code but doesn't include test changes.

                **Changed source files:**
                ${sourceFiles.map(f => `- \`${f.filename}\``).join('\n')}

                Consider adding tests to ensure:
                - âœ… New functionality works as expected
                - âœ… Edge cases are covered
                - âœ… Regressions are prevented

                See [tests/README.md](../blob/main/tests/README.md) for guidance on adding tests.

                *If tests aren't applicable for this PR, please explain why in the description.*`
              });

              // Add label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['needs-tests']
              });
            }
